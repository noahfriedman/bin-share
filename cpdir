#!/bin/sh
# cpdir --- copy directories preserving time, symlinks, etc.
# Author: Noah Friedman <friedman@prep.ai.mit.edu>
# Created: 1991-08-14
# Public domain.

# $Id: cpdir,v 1.4 1994/05/22 03:34:13 friedman Exp friedman $

# Commentary:
# Code:

# Name by which this script was invoked.
progname=`echo "$0" | sed -e 's/[^\/]*\///g'`

# To prevent hairy quoting and escaping later.
bq='`'
eq="'"

usage="Usage: $progname {options} srcdir {srcdir2 ...} dstdir

Options are:
-D, --debug                  Turn on shell debugging ($bq${bq}set -x$eq$eq).
-f, --full-path              Copy entire src directory component.
-h, --help                   You're looking at it.
-v, --verbose                Print filenames as they're copied.

Example: ${progname} /home/fsf/friedman /home/gp
         => /home/fsf/friedman -> /home/gp/friedman

         ${progname} --full-path /home/fsf/friedman /home/gp
         => /home/fsf/friedman -> /home/gp/home/fsf/friedman

"

# Initialize variables.
# Don't use `unset' since old bourne shells don't have this command.
# Instead, assign them an empty value.
debug=
verbose=
fullpath=

# Parse command line arguments.
# Make sure that all wildcarded options are long enough to be unambiguous.
# It's a good idea to document the full long option name in each case.
# Long options which take arguments will need a `*' appended to the
# canonical name to match the value appended after the `=' character.
while test $# != 0; do
  case "$1" in
    -D | --debug | --d* )
      debug=t
      shift
     ;;
    -f | --full-path | --f* )
      fullpath=t
      shift
     ;;
    -h | --help | --h )
      echo "$usage" 1>&2
      exit 1
     ;;
    -v | --verbose | --v* )
      verbose="-v"
      shift
     ;;
    -- )     # Stop option processing
      shift
      break
     ;;
    -? | --* )
      case "$1" in
        --*=* ) arg=`echo "$1" | sed -e 's/=.*//'` ;;
        * )     arg="$1" ;;
      esac
      exec 1>&2
      echo "$progname: unknown or ambiguous option $bq$arg$eq"
      echo "$progname: Use $bq--help$eq for a list of options."
      exit 1
     ;;
    -??* )
      # Split grouped single options into separate args and try again
      optarg="$1"
      shift
      set fnord `echo "x$optarg" | sed -e 's/^x-//;s/\(.\)/-\1 /g'` ${1+"$@"}
      shift
     ;;
    * )
      break
     ;;
  esac
done

case "$debug" in t ) set -x ;; esac

_saved_args=
while : ; do
  case $# in 0 | 1 ) break ;; esac
  eval _saved_args$#=\$1
  _saved_args="$_saved_args \"\$_saved_args$#\""
  shift
done

dst=$1
eval '{ eval set fnord $_saved_args; }'
shift

for src in ${1+"$@"} ; do
  case "$fullpath" in
    t )
      srcdir=.
      case "$src" in
        /* )
          srcdir=/
          src=`echo "$src" | sed -e 's/^\/*//'`
         ;;
      esac
     ;;
    * )
      # sed is more portable than `dirname'
      srcdir=`echo "$src" \
              | sed -e 's/\/*$//
                        s/\/[^\/]*$//'`

      case "$srcdir" in "$src" )
        srcdir=. ;;
      esac

      # same as `basename'
      src=`echo "$src" \
           | sed -e 's/\/*$//
                     s/.*\///'`
     ;;
  esac

  if test -d "$dst" ; then
    ( cd "$srcdir" && tar -cf - "$src" ) \
     | ( cd "$dst" && tar $verbose -xpf - )
  else
    mkdir "$dst"
    ( cd "$srcdir/$src" && tar -cf - . ) \
     | ( cd "$dst" && tar $verbose -xpf - )
  fi
done

# cpdir ends here
