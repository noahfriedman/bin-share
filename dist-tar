#! /bin/sh
# $Id: dist-tar,v 1.9 2015/09/12 04:46:22 friedman Exp $

LC_COLLATE=C
export LC_COLLATE

if ${TAR-tar} --version 2>&1 | grep 'GNU tar' > /dev/null; then
  gnutar=t
fi

case $1 in
    -gzip | -bzip2 | -lzma | -xz ) DIST_TAR_ZIP=${1#-} ; shift ;;
esac

case ${DIST_TAR_ZIP-gzip} in
  gzip  ) zip=gzip  z=gz   zargs='-9' ;;
  bzip2 ) zip=bzip2 z=bz2  zargs='-9' ;;
  lzma  ) zip=lzma  z=lzma zargs='-9 --extreme --threads=0' ;;
  xz    ) zip=xz    z=xz   zargs='-9 --extreme --threads=0' ;;
  *     ) echo "dist-tar: $DIST_TAR_ZIP: unknown compression method" 1>&2
          exit 1 ;;
esac

for dir in ${1+"$@"} ; do
  # Protect against accidental trailing slash, i.e. if someone does
  # dist-tar foo/, don't create foo/.tar.gz only to delete foo
  # afterward.
  case $dir in
    */ ) dir=`echo "$dir" | sed -e 's=/$==g'` ;;
  esac

  echo "dist-tar: packing $dir.tar.$z"

  { case $gnutar in
      t ) find "$dir" -print \
           | sort \
           | ${TAR-tar} ${TAROPT} --no-recursion -T - -cvf - \
           | $zip $zargs > "$dir.tar.$z" ;;

      * ) ${TAR-tar} ${TAROPT} -cvf - "$dir" \
           | $zip $zargs > "$dir.tar.$z" ;;
    esac
  } && touch -r "$dir" "$dir.tar.$z" \
    && rm -rf "$dir"
done

# eof
